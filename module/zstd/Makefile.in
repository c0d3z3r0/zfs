src = @abs_top_srcdir@/module/zstd
obj = @abs_builddir@

MODULE := zzstd

obj-$(CONFIG_ZFS) := $(MODULE).o

ZFS_MODULE_CFLAGS += -I$(src)/include

asflags-y := $(ZFS_MODULE_CFLAGS)
ccflags-y := $(ZFS_MODULE_CFLAGS) $(ZFS_MODULE_CPPFLAGS)

# Suppress unused but set variable warnings often due to ASSERTs
ccflags-y += $(NO_UNUSED_BUT_SET_VARIABLE)

# Zstd uses -O3 by default, so we should follow
ccflags-y += -O3

# -fno-tree-vectorize gets set for gcc in zstd/common/compiler.h
# Set it for other compilers, too.
$(obj)/zstdlib.o: c_flags += -fno-tree-vectorize

# Quiet warnings about frame size due to unused code in unmodified zstd lib
$(obj)/zstdlib.o: c_flags += -Wframe-larger-than=20480

# Disable aarch64 neon SIMD instructions for kernel mode
$(obj)/zstdlib.o: c_flags += -include $(src)/include/aarch64_compat.h

$(MODULE)-objs += zstd.o
$(MODULE)-objs += zstdlib.o
